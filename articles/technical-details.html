<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technical Details • nytindia</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Technical Details">
<meta property="og:description" content="nytindia">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nytindia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/analysis.html">Analysis</a>
    </li>
    <li>
      <a href="../articles/technical-details.html">Technical Details</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="technical-details_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Technical Details</h1>
                        <h4 class="author">Sean Angiolillo</h4>
            
      
      
      <div class="hidden name"><code>technical-details.Rmd</code></div>

    </div>

    
    
<p>For those more interested in the contents of the package rather than analysis of the actual data at hand, here I detail some of the key steps.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://seanangio.github.io/nytindia">nytindia</a></span><span class="op">)</span></code></pre></div>
<div id="preparing-the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#preparing-the-data" class="anchor"></a>Preparing the Data</h1>
<p>The main steps for preparing the data found in the Shiny app were to:</p>
<ul>
<li>query article data from <a href="https://developer.nytimes.com/docs/articlesearch-product/1/overview">The New York Times Article Search API</a>;</li>
<li>clean the data, especially consolidating categorical values representing the same entity into one value;</li>
<li>transform the original data frame, where each row is an article and keywords are a nested column, to an unnested data frame, where each row is a keyword in an article;</li>
<li>geocode location keywords using the <a href="https://developer.mapquest.com/documentation/geocoding-api/">Mapquest Geocoding API</a>;</li>
<li>prepare data on Indian government tenures from <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_India">Wikipedia</a>.</li>
</ul>
<p>I provide more detail on each of these steps in the sections below.</p>
<div id="querying-the-nyt-article-search-api" class="section level2">
<h2 class="hasAnchor">
<a href="#querying-the-nyt-article-search-api" class="anchor"></a>Querying the NYT Article Search API</h2>
<p>This project started with querying <a href="https://developer.nytimes.com/docs/articlesearch-product/1/overview">The New York Times Article Search API</a>.</p>
<p>My goal was to collect every article in The New York Times “about India” dating back as far as possible. Accordingly, the query string required that all results include:</p>
<ul>
<li>an “India” location keyword tag,</li>
<li>the document type “article”,</li>
<li>and the source be one of “The New York Times”, “International New York Times”, or “International Herald Tribune”.</li>
</ul>
<p>After reading a few tutorials on querying The New York Times’ API, like <a href="http://www.storybench.org/working-with-the-new-york-times-api-in-r/">this one</a>, it was not too difficult to get the results I wanted.</p>
<p>My code in <code>R/01-query-nyt-api.R</code> is probably not the most robust script, but the main learning point was to iterate over small chunks of time.</p>
<p>My query script essentially has two loops:</p>
<ul>
<li>The outer loop iterates over time periods.</li>
<li>The inner loop iterates over page results.</li>
</ul>
<p>The API returns 10 articles at a time. In order to stay within the limits of the API, you won’t get too far querying the full time range all at once because as you paginate through results, the response time slows. When trying to query the results for one year, I wasn’t close to reaching the daily limit of 4,000 requests (40,000 articles), but my query was timing out.</p>
<p>Having smaller time chunks ensures having fewer page results for each time chunk. Once switching to a monthly increment, I was able to retrieve all results in one job.</p>
</div>
<div id="consolidating-categories" class="section level2">
<h2 class="hasAnchor">
<a href="#consolidating-categories" class="anchor"></a>Consolidating Categories</h2>
<p>My API query produced a folder with one file for every year-month combination. The next step was to combine those files into one data frame, remove unnecessary columns, and begin cleaning the data (<code>R/02-prepare-nested.R</code>).</p>
<p>Many of the columns in the dataset contained multiple values that represent the same or nearly the same entity.</p>
<p>For example, the raw values for a column like <em>news_desk</em> included “Business/Finance”, “Money and Business/Financial”, “Financial”, “Business”, “Business/World Business”, and “Business / World Business”.</p>
<p>The same problem presented itself with a column like keyword values. To give one example, there were nine different attributions all referring to the same person (“Gandhi, Mohandas Karamchand”).</p>
<p>I needed to consolidate values referring to the same entity to one single value. I initially approached this problem with a very long <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> statement. This quickly became untenable though as the severity of the problem became apparent.</p>
<p>A more automated solution like fuzzy matching, or approximate string matching, was also not viable as many of the correct matches are not actually that close in terms of string distance. On the other hand, values like “Gandhi, Rahul” and “Gandhi, Rajiv” are close in terms of string distance, but are two different people. Accordingly, all renaming required human review.</p>
<p>My solution was to write a small Shiny app that would make it easy to create lookup tables. The code for this app is included in the package <a href="https://github.com/seanangio/nytindia/inst/examples/lookup_table_app">here</a>.</p>
<p>I would first create a file with counts of distinct names for a column like news desk or keyword values. I would choose the name I wanted to keep. The app would then sort all of the other values in the column by string distance. Between the similarity score and searching in the DataTable, I was able to find the most likely values to be consolidated under the chosen name.</p>
<div class="figure">
<img src="lookup-table-app.png" style="width:75.0%" alt=""><p class="caption">Screenshot of Lookup Table shiny app</p>
</div>
</div>
<div id="nested-vs--unnested-data" class="section level2">
<h2 class="hasAnchor">
<a href="#nested-vs--unnested-data" class="anchor"></a>Nested vs. Unnested Data</h2>
<p>Another challenge in preparing the data was handling nested keywords. After combining all of the raw files into one data frame, every record represents one article. (Think of the <strong>Table</strong> tab of the <code>nyt_india_app</code>). The keywords for every article are structured as a nested data frame. You can see this in the final nested data frame below.</p>
<pre><code>#&gt; Rows: 33,713
#&gt; Columns: 15
#&gt; $ url            &lt;chr&gt; "https://www.nytimes.com/2020/12/31/arts/design/louis-k…
#&gt; $ pub_date       &lt;date&gt; 2020-12-31, 2020-12-24, 2020-12-24, 2020-12-24, 2020-1…
#&gt; $ headline       &lt;chr&gt; "Louis Kahn-Designed Dorms in India May Be Razed", "How…
#&gt; $ news_desk      &lt;chr&gt; "The Arts/Cultural", "OpEd", "Business/Financial", "Was…
#&gt; $ section        &lt;chr&gt; "Arts", "Opinion", "Technology", "World", "Times Inside…
#&gt; $ material       &lt;chr&gt; "News", "Op-Ed", "News", "News", "News", "News", "Op-Ed…
#&gt; $ byline         &lt;chr&gt; "Matt Shaw", "Nikhil Kumar", "Priya Arora and Karan Dee…
#&gt; $ abstract       &lt;chr&gt; "Plans to demolish part of a Kahn project at the Indian…
#&gt; $ lead_paragraph &lt;chr&gt; "A world-class architectural-preservation controversy i…
#&gt; $ front_page     &lt;lgl&gt; FALSE, FALSE, TRUE, FALSE, FALSE, NA, FALSE, FALSE, FAL…
#&gt; $ printed        &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, FALSE, TRUE, TRUE, TRUE, …
#&gt; $ keywords       &lt;list&gt; [&lt;tbl_df[11 x 6]&gt;], [&lt;tbl_df[8 x 6]&gt;], [&lt;tbl_df[11 x 6…
#&gt; $ india_rank     &lt;dbl&gt; 2, 1, 1, 1, 3, 12, 10, 10, 3, 1, 1, 10, 5, 1, 15, 7, 11…
#&gt; $ max_kword      &lt;dbl&gt; 11, 8, 11, 15, 4, 26, 11, 11, 6, 3, 11, 12, 6, 6, 17, 9…
#&gt; $ in_of_n_kword  &lt;glue&gt; "2 of 11", "1 of 8", "1 of 11", "1 of 15", "3 of 4", "…</code></pre>
<p>The nested <em>keywords</em> data frame from the Article Search API includes not only the keyword value, but also a category (“subject”, “person”, “glocation”, “organization”, or “creative_work”) and its rank of importance in the article. The <em>lat</em>, <em>lon</em>, and <em>country</em> columns are added in the step below. Here’s one example:</p>
<pre><code>#&gt; # A tibble: 11 x 6
#&gt;    name          value                                  rank   lat   lon country
#&gt;    &lt;chr&gt;         &lt;chr&gt;                                 &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;  
#&gt;  1 subject       architecture                              1  NA    NA   FALSE  
#&gt;  2 glocations    india                                     2  27.1  80.3 TRUE   
#&gt;  3 persons       kahn, louis i                             3  NA    NA   FALSE  
#&gt;  4 subject       dormitories                               4  NA    NA   FALSE  
#&gt;  5 organizations world monuments fund                      5  NA    NA   FALSE  
#&gt;  6 persons       doshi, balkrishna                         6  NA    NA   FALSE  
#&gt;  7 glocations    ahmedabad (india)                         7  23.0  72.6 FALSE  
#&gt;  8 organizations indian institute of management ahmed…     8  NA    NA   FALSE  
#&gt;  9 subject       historic buildings and sites              9  NA    NA   FALSE  
#&gt; 10 subject       demolition                               10  NA    NA   FALSE  
#&gt; 11 subject       colleges and universities                11  NA    NA   FALSE</code></pre>
<p>In preparing the data, {tidyr}’s <code>nest()</code> and <code>unnest()</code> functions are used for this task. However, in the Shiny app itself, to go from unnested to nested versions, it’s faster to just acquire the distinct URLs from the unnested data frame and use that to filter the nested data frame.</p>
</div>
<div id="querying-location-data" class="section level2">
<h2 class="hasAnchor">
<a href="#querying-location-data" class="anchor"></a>Querying Location Data</h2>
<p>Once keyword values were unnested and cleaned, I wanted to join in geographic coordinates in order to visualize the location keywords on a map.</p>
<p>There are a number of free geocoding APIs available, many with R wrappers. I chose to query the <a href="https://developer.mapquest.com/documentation/geocoding-api/">Mapquest Geocoding API</a> to return a longitude and latitude coordinate for every unique location keyword. I expect there are a few errors, but overall it did a good job.</p>
<p>Again, my script (<code>R/07-query-mapquest.R</code>) is likely not the most robust, but, as there were a relatively small number of locations, it wasn’t a difficult task.</p>
<p>Location keywords include both cities and countries. They should really be distinguished in some way before plotting as bubbles on the same map. To achieve this, I joined in a list of country name data in order to identify which keywords are countries. Once again, likely not a perfect list, but it did the job. See <code>R/08-add-coords-countries.R</code> for details.</p>
</div>
<div id="preparing-government-data" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-government-data" class="anchor"></a>Preparing Government Data</h2>
<p>One last piece of data needed was a history of Indian governments. This enabled filtering the dataset by a specific party or prime minister instead of a single date range. It also provided a helpful background for the timeline.</p>
<p>This data came from <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_India">Wikipedia</a>. Instead of scraping it directly, copy-pasting into a Google sheet and then using the {datapasta} package was the easiest way to get the data into R. See <code>data-raw/govt.R</code> for more details.</p>
<pre><code>#&gt; Rows: 28
#&gt; Columns: 7
#&gt; $ pm        &lt;chr&gt; "Viceroy", "Jawaharlal Nehru", "Jawaharlal Nehru", "Jawaharl…
#&gt; $ party     &lt;chr&gt; "British Raj", "Indian National Congress", "Indian National …
#&gt; $ from      &lt;date&gt; 1855-01-01, 1947-08-15, 1952-04-15, 1957-04-17, 1962-04-02,…
#&gt; $ to        &lt;date&gt; 1947-08-14, 1952-04-14, 1957-04-16, 1962-04-01, 1964-05-26,…
#&gt; $ color     &lt;chr&gt; "#fb9a99", "#a6cee3", "#a6cee3", "#a6cee3", "#a6cee3", "#a6c…
#&gt; $ abb       &lt;chr&gt; "GB", "INC", "INC", "INC", "INC", "INC", "INC", "INC", "INC"…
#&gt; $ govt_name &lt;glue&gt; "1855-01-01 / 1947-08-14: Viceroy (British Raj)", "1947-08-…</code></pre>
</div>
</div>
<div id="building-the-shiny-app" class="section level1">
<h1 class="hasAnchor">
<a href="#building-the-shiny-app" class="anchor"></a>Building the Shiny App</h1>
<p>The key points for building the Shiny app were:</p>
<ul>
<li>simplifying <code>ui.R</code> with UI functions</li>
<li>writing the function to filter the unnested data frame</li>
<li>choosing the visualization libraries for each tab.</li>
<li>pulling non-reactive code out of <code>server.R</code> and into functions kept in <code>global.R</code>.</li>
</ul>
<div id="the-ui" class="section level2">
<h2 class="hasAnchor">
<a href="#the-ui" class="anchor"></a>The UI</h2>
<p>The UI for this Shiny app is actually quite simple.</p>
<p><strong>UI functions</strong>, as described in the <a href="https://mastering-shiny.org/scaling-functions.html#ui-functions">Mastering Shiny book</a>, were a great help to reduce the code in <code>ui.R</code>. There are about 15 inputs just on the <strong>Filters</strong> tab. Most are very similar.</p>
<p>After writing a <code>myInput()</code> function, I was able to store most of the input information in one table and call on it with functions. Doing so increased clarity and reduced code duplication.</p>
</div>
<div id="filtering-the-unnested-data" class="section level2">
<h2 class="hasAnchor">
<a href="#filtering-the-unnested-data" class="anchor"></a>Filtering the Unnested Data</h2>
<p>The most important function in <code>global.R</code> is <code>filter_unnested()</code>. It filters the the complete unnested data frame (where each row represents a keyword belonging to an article) based on about 15 different user inputs.</p>
<p>Filtering for some of these inputs like <em>news_desk</em>, <em>section</em> or <em>material</em> is quite simple. Others, such as keyword filtering, require more complicated logic.</p>
<p>When filtering by keywords, you first need to obtain the correct set of article URLs. This is because for visualizations like the keyword pairs or even the bar plot of counts, you want to retain the other keywords in articles matching the filter.</p>
<p>For example, imagine the user wants to filter for all articles with a keyword “pakistan”. We need to find the article URLs with the matching keyword, and then use those URLs to filter the dataset. Otherwise, the other keywords in articles with a “pakistan” keyword would be lost, and visualizations like the bar plot or keyword pairs would be empty.</p>
<p>Once you have the correct unnested data frame, you also need a nested version (where each row is an article) that can be used in visualizations like the <strong>Table</strong> or <strong>Timeline</strong>. Instead of going to the trouble of actually nesting it each time though, the <code>nest_df()</code> function just gets the distinct URLs in the unnested data frame and then performs a join on the full nested data frame.</p>
</div>
<div id="visualizations" class="section level2">
<h2 class="hasAnchor">
<a href="#visualizations" class="anchor"></a>Visualizations</h2>
<p>Once the correct reactive (nested or unnested) data frame is available, creating the actual visualizations is fairly simple.</p>
<ul>
<li>For maps, the obvious choice is {leaflet}.</li>
<li>For bar plots and the heatmap, I chose {ggiraph}. {plotly} is a popular option, but I’ve always found {ggiraph} to be very easy to add interactivity to a ggplot.</li>
<li>For the timeline, I chose {dygraphs}. {ggplot} + {ggiraph} would have been an option, but I wanted to try out this package dedicated to time series.</li>
</ul>
</div>
<div id="server-logic" class="section level2">
<h2 class="hasAnchor">
<a href="#server-logic" class="anchor"></a>Server Logic</h2>
<p>As suggested in <a href="https://mastering-shiny.org/scaling-functions.html#server-functions">Mastering Shiny</a>, I tried to keep all of the non-reactive code outside of <code>server.R</code>.</p>
<p>Aside from calculating the outputs, most of the code in <code>server.R</code> is for filtering the data by interacting with the visualizations themselves. Using Shiny with {DT}, {ggiraph}, {dygraphs}, and {leaflet} follows a similar pattern in saving a click event with an <code>eventReactive()</code>.</p>
</div>
</div>
<div id="making-a-package" class="section level1">
<h1 class="hasAnchor">
<a href="#making-a-package" class="anchor"></a>Making a Package</h1>
<p>This project was originally a typical data analysis project: a series of scripts that produced an output dataset, combined with a shiny app for visualization.</p>
<p>I decided to take it one step further and re-structure it as a package. This makes it easier to update the data every month and was a great learning opportunity.</p>
</div>
<div id="acknowledgements" class="section level1">
<h1 class="hasAnchor">
<a href="#acknowledgements" class="anchor"></a>Acknowledgements</h1>
<p>In addition to the importance of the {<a href="https://www.tidyverse.org/">tidyverse</a>} and {<a href="https://shiny.rstudio.com/">shiny</a>} packages, I’d also like to thank the authors of packages such as {<a href="https://dreamrs.github.io/shinyWidgets/index.html">shinyWidgets</a>}, {<a href="https://rstudio.github.io/DT/">DT</a>}, {<a href="https://davidgohel.github.io/ggiraph/">ggiraph</a>}, {<a href="https://rstudio.github.io/dygraphs/">dygraphs</a>}, {<a href="https://gt.rstudio.com/">gt</a>}, {<a href="https://rstudio.github.io/leaflet/">leaflet</a>}, {<a href="http://ijlyttle.github.io/bsplus/">bsplus</a>}, {<a href="https://waiter.john-coene.com/#/">waiter</a>}, and {<a href="https://daattali.com/shiny/shinycssloaders-demo/">shinycssloaders</a>}.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Sean Angiolillo.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
